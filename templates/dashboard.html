<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Algo Terminal V3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 80px; }
        .ticker-bar { background: #111; color: #fff; padding: 8px; font-size: 0.85rem; white-space: nowrap; overflow-x: auto; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .ticker-item { margin-right: 15px; font-weight: 600; }
        .auth-btn { font-size: 0.75rem; padding: 4px 12px; border-radius: 20px; text-decoration: none; font-weight: bold; background: #dc3545; color: white; }
        .custom-card { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); background: #fff; margin-bottom: 15px; }
        .card-head { padding: 12px 15px; font-weight: 700; border-bottom: 1px solid #f0f0f0; background: #fff; color: #333; }
        .card-body { padding: 15px; }
        .nav-tabs { border: none; background: #fff; padding: 8px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; }
        .nav-btn { flex: 1; text-align: center; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #6c757d; margin: 0 2px; font-size: 0.9rem; }
        .nav-btn.active { background-color: #0d6efd; color: #fff; }
        .pnl-green { color: #198754; font-weight: bold; font-size: 0.8rem; display: block; } 
        .pnl-red { color: #dc3545; font-weight: bold; font-size: 0.8rem; display: block; }
        .pos-grid-label { font-size: 0.7rem; color: #888; font-weight: 600; text-transform: uppercase; }
        .pos-grid-val { font-weight: 700; font-size: 0.9rem; }
        .log-entry { font-size: 0.75rem; border-left: 2px solid #ddd; padding-left: 8px; margin-bottom: 4px; color: #555; }
        .tab-content { display: none; } .tab-content.active { display: block; }
    </style>
</head>
<body>

<div class="container mt-3">
    {% with messages = get_flashed_messages() %}
        {% if messages %} <div class="alert alert-info py-2 shadow-sm border-0">{{ messages[0] }}</div> {% endif %}
    {% endwith %}

    {% if not is_active %}
    <div class="custom-card p-5 text-center mt-5">
        <h2>üîå Offline</h2>
        <a href="{{ login_url }}" class="btn btn-primary btn-lg mt-3 w-100 fw-bold">Login to Zerodha</a>
    </div>
    {% else %}
    
    <div class="ticker-bar rounded mb-3 shadow-sm">
        <div>
            <span class="ticker-item">NIFTY: <span id="n_lp" class="text-warning">...</span></span>
            <span class="ticker-item">BANK: <span id="b_lp" class="text-warning">...</span></span>
        </div>
        <a href="/logout" class="auth-btn">Logout</a>
    </div>

    <div class="nav-tabs">
        <div class="nav-btn active" onclick="switchTab('trade')">üöÄ Trade</div>
        <div class="nav-btn" onclick="switchTab('pos')">üíº Active</div>
        <div class="nav-btn" onclick="switchTab('closed')">üìú Closed</div>
        <div class="nav-btn" onclick="switchTab('history')">üìÖ Simulator</div>
    </div>

    <div id="trade" class="tab-content active">
        <form action="/trade" method="post">
            <div class="custom-card">
                <div class="card-head d-flex justify-content-between"><span>New Order</span> <span id="inst_ltp" class="badge bg-primary">LTP: 0</span></div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="pos-grid-label">SYMBOL</label>
                        <input type="text" id="sym" name="index" class="form-control fw-bold" placeholder="e.g. NIFTY" list="sym_list" required>
                        <datalist id="sym_list"></datalist>
                    </div>
                    <div class="mb-3">
                        <select name="type" id="type" class="form-select fw-bold"><option value="CE">CE</option><option value="PE">PE</option><option value="FUT">FUT</option><option value="EQ">EQ</option></select>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><select name="expiry" id="exp" class="form-select"></select></div>
                        <div class="col-6"><select name="strike" id="str" class="form-select"></select></div>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><label class="pos-grid-label">QTY (<span id="lot">1</span>)</label><input type="number" name="qty" id="qty" class="form-control fw-bold" value="1"></div>
                        <div class="col-6"><label class="pos-grid-label">ORDER</label><select name="order_type" class="form-select fw-bold"><option value="LIMIT">LIMIT</option><option value="MARKET">MARKET</option></select></div>
                    </div>
                    <input type="number" step="0.05" name="limit_price" id="lim_pr" class="form-control mb-3 text-primary fw-bold" placeholder="Limit Price">
                </div>
            </div>

            <div class="custom-card">
                <div class="card-head">üõ°Ô∏è Projected P&L</div>
                <div class="card-body">
                    <div class="input-group mb-3"><span class="input-group-text">SL Pts</span><input type="number" id="sl_pts" name="sl_points" class="form-control fw-bold text-center" value="20"></div>
                    <div class="row g-2 text-center">
                        <div class="col-3">
                            <small class="text-danger fw-bold">SL</small>
                            <input type="text" id="p_sl" class="form-control text-center text-danger fw-bold mb-1" readonly>
                            <span id="pnl_sl" class="pnl-red">‚Çπ 0</span>
                        </div>
                        <div class="col-3">
                            <small class="text-success fw-bold">T1</small>
                            <input type="text" id="p_t1" name="t1_price" class="form-control text-center text-success fw-bold mb-1">
                            <span id="pnl_t1" class="pnl-green">‚Çπ 0</span>
                        </div>
                        <div class="col-3">
                            <small class="text-success fw-bold">T2</small>
                            <input type="text" id="p_t2" name="t2_price" class="form-control text-center text-success fw-bold mb-1">
                            <span id="pnl_t2" class="pnl-green">‚Çπ 0</span>
                        </div>
                        <div class="col-3">
                            <small class="text-success fw-bold">T3</small>
                            <input type="text" id="p_t3" name="t3_price" class="form-control text-center text-success fw-bold mb-1">
                            <span id="pnl_t3" class="pnl-green">‚Çπ 0</span>
                        </div>
                    </div>
                </div>
            </div>

            <input type="hidden" name="mode" id="mode_input" value="PAPER">
            <div class="d-flex gap-2 mb-3">
                <div class="btn btn-outline-warning w-50 fw-bold active" onclick="setMode(this, 'PAPER')">PAPER</div>
                <div class="btn btn-outline-danger w-50 fw-bold" onclick="setMode(this, 'LIVE')">LIVE</div>
            </div>
            <button type="submit" class="btn btn-dark w-100 py-3 fw-bold rounded-pill shadow">üöÄ EXECUTE</button>
        </form>
    </div>

    <div id="pos" class="tab-content">
        <div class="custom-card">
            <div class="card-head">üíº Active Positions</div>
            <div class="card-body p-2" id="pos-container">
                <div class="text-center p-4 text-muted">Loading...</div>
            </div>
        </div>
    </div>

    <div id="closed" class="tab-content">
        <div class="custom-card">
            <div class="card-head">üìú Closed Trades</div>
            <div class="card-body p-2" id="hist-container">
                <div class="text-center p-4 text-muted">Loading...</div>
            </div>
        </div>
    </div>

    <div id="history" class="tab-content">
        <div class="custom-card">
            <div class="card-head">üìÖ Trade Simulator</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="pos-grid-label">SEARCH SYMBOL</label>
                    <input type="text" id="h_sym" class="form-control fw-bold" placeholder="Symbol" list="h_sym_list">
                    <datalist id="h_sym_list"></datalist>
                </div>
                
                <div class="row g-2 mb-3">
                    <div class="col-4"><select id="h_type" class="form-select"><option>CE</option><option>PE</option><option>FUT</option></select></div>
                    <div class="col-8"><select id="h_exp" class="form-select"></select></div>
                </div>
                <select id="h_str" class="form-select mb-3"><option>Select Expiry First</option></select>
                
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="pos-grid-label">ENTRY PRICE <span class="text-danger">*</span></label>
                        <input type="number" step="0.05" id="h_entry" class="form-control fw-bold border-primary" placeholder="Required">
                    </div>
                    <div class="col-6">
                        <label class="pos-grid-label">ENTRY TIME</label>
                        <input type="datetime-local" id="h_time" class="form-control">
                    </div>
                </div>
                
                <div class="p-2 bg-light rounded border mb-3">
                    <div class="row g-2 align-items-end mb-2">
                        <div class="col-6">
                            <label class="pos-grid-label">SL Points</label>
                            <input type="number" id="h_sl_pts" class="form-control" value="20">
                        </div>
                        <div class="col-6">
                            <label class="pos-grid-label">Qty</label>
                            <input type="number" id="h_qty" class="form-control fw-bold" value="50">
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="row g-2 text-center">
                        <div class="col-4">
                            <small class="text-success fw-bold">T1</small>
                            <input type="number" step="0.05" id="h_t1" class="form-control form-control-sm mb-1">
                            <span id="h_pnl_t1" class="pnl-green">‚Çπ 0</span>
                        </div>
                        <div class="col-4">
                            <small class="text-success fw-bold">T2</small>
                            <input type="number" step="0.05" id="h_t2" class="form-control form-control-sm mb-1">
                            <span id="h_pnl_t2" class="pnl-green">‚Çπ 0</span>
                        </div>
                        <div class="col-4">
                            <small class="text-success fw-bold">T3</small>
                            <input type="number" step="0.05" id="h_t3" class="form-control form-control-sm mb-1">
                            <span id="h_pnl_t3" class="pnl-green">‚Çπ 0</span>
                        </div>
                    </div>
                    <div class="mt-2 text-center">
                        <small class="text-danger fw-bold">Potential Loss: </small>
                        <span id="h_pnl_sl" class="pnl-red" style="display:inline;">‚Çπ 0</span>
                    </div>
                </div>

                <button onclick="checkHistory()" class="btn btn-info w-100 fw-bold text-white">üîÑ Run Simulation</button>
                <div id="h_res" class="mt-3 p-3 bg-light border rounded" style="display:none;"></div>
            </div>
        </div>
    </div>

    {% endif %}
</div>

<script>
    function switchTab(id) { $('.tab-content').hide(); $(`#${id}`).show(); $('.nav-btn').removeClass('active'); $(event.target).addClass('active'); if(id==='closed') loadClosedTrades(); }
    function setMode(el, mode) { $('#mode_input').val(mode); $(el).parent().find('.btn').removeClass('active'); $(el).addClass('active'); }

    // --- DATA ---
    let curLTP=0;
    let symLTP = {};

    function updateData() {
        if(!document.getElementById('n_lp')) return;
        $.get('/api/indices', d => { $('#n_lp').text(d.NIFTY); $('#b_lp').text(d.BANKNIFTY); });
        $.get('/api/positions', trades => {
            let html = '';
            if(trades.length === 0) html = '<div class="text-center p-4 text-muted">No Active Trades</div>';
            else {
                trades.forEach(t => {
                    let pnl = (t.current_ltp - t.entry_price) * t.quantity;
                    let color = pnl >= 0 ? 'pnl-green' : 'pnl-red';
                    html += `<div class="card mb-3 border shadow-sm"><div class="card-body p-3">
                        <div class="d-flex justify-content-between mb-2"><h6 class="fw-bold mb-0">${t.symbol} <span class="badge bg-light text-dark border ms-2">Qty: ${t.quantity}</span></h6><span class="badge ${t.mode=='LIVE'?'bg-danger':'bg-warning text-dark'}">${t.mode}</span></div>
                        <div class="text-center py-2 bg-light rounded mb-3"><small class="text-muted fw-bold">P&L</small><h3 class="mb-0 fw-bold ${color}">${pnl.toFixed(2)}</h3></div>
                        <div class="row text-center mb-2"><div class="col-6 border-end"><div class="pos-grid-label">Entry</div><div class="pos-grid-val">${t.entry_price.toFixed(2)}</div></div><div class="col-6"><div class="pos-grid-label">LTP</div><div class="pos-grid-val text-primary">${t.current_ltp.toFixed(2)}</div></div></div>
                        <div class="row text-center border-top pt-2"><div class="col-3"><div class="pos-grid-label text-danger">SL</div><small class="fw-bold">${t.sl.toFixed(1)}</small></div><div class="col-3"><div class="pos-grid-label text-success">T1</div><small class="fw-bold">${t.targets[0].toFixed(1)}</small></div><div class="col-3"><div class="pos-grid-label text-success">T2</div><small class="fw-bold">${t.targets[1].toFixed(1)}</small></div><div class="col-3"><div class="pos-grid-label text-success">T3</div><small class="fw-bold">${t.targets[2].toFixed(1)}</small></div></div>
                        <div class="mt-3 d-flex justify-content-between"><a href="/close_trade/${t.id}" class="btn btn-sm btn-dark w-100 fw-bold">Exit Position</a>${t.mode=='PAPER' ? `<a href="/promote/${t.id}" class="btn btn-sm btn-outline-danger ms-2 fw-bold">Live</a>` : ''}</div></div></div>`;
                });
            }
            $('#pos-container').html(html);
        });
    }
    setInterval(updateData, 2000); updateData();

    function loadClosedTrades() {
        $.get('/api/closed_trades', trades => {
            let html = '';
            if(trades.length === 0) html = '<div class="text-center p-4 text-muted">No History</div>';
            else {
                trades.forEach(t => {
                    let color = t.pnl >= 0 ? 'pnl-green' : 'pnl-red';
                    let logs = t.logs ? t.logs.map(l => `<div class="log-entry">${l}</div>`).join('') : '';
                    html += `<div class="card mb-3 border shadow-sm"><div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center"><h6 class="fw-bold mb-0">${t.symbol}</h6><span class="badge bg-secondary">${t.status}</span></div>
                        <div class="d-flex justify-content-between mt-2"><small>Entry: <b>${t.entry_price.toFixed(2)}</b></small><small>Exit: <b>${t.exit_price.toFixed(2)}</b></small></div>
                        <div class="d-flex justify-content-between mt-2 align-items-center"><small class="text-muted">${t.exit_time}</small><h5 class="mb-0 fw-bold ${color}">${t.pnl}</h5></div>
                        <div class="mt-2 pt-2 border-top bg-light p-2 rounded"><small class="fw-bold text-muted">Logs:</small>${logs}</div></div></div>`;
                });
            }
            $('#hist-container').html(html);
        });
    }

    // --- SHARED LOGIC ---
    function bindSearch(id, listId) {
        $(id).on('input', function() { 
            if(this.value.length>1) $.get('/api/search?q='+this.value, d => { 
                $(listId).empty(); d.forEach(s=>$(listId).append(`<option value="${s}">`)) 
            }); 
        });
    }
    bindSearch('#sym', '#sym_list'); 
    bindSearch('#h_sym', '#h_sym_list');

    function loadDetails(symId, expId, typeId, qtyId) {
        let s = $(symId).val(); if(!s) return;
        $.get('/api/details?symbol='+s, d => { 
            symLTP[symId] = d.ltp; 
            if(d.lot_size > 0) {
                if(symId === '#sym') { $('#lot').text(d.lot_size); }
                $(qtyId).val(d.lot_size).attr('step', d.lot_size).attr('min', d.lot_size);
            }
            window[symId+'_fut'] = d.fut_expiries; window[symId+'_opt'] = d.opt_expiries;
            fillExp(expId, typeId, symId);
        });
    }
    $('#sym').change(() => loadDetails('#sym', '#exp', '#type', '#qty'));
    $('#h_sym').change(() => loadDetails('#h_sym', '#h_exp', '#h_type', '#h_qty'));

    function fillExp(expId, typeId, symId) { 
        let l = $(typeId).val()=='FUT' ? window[symId+'_fut'] : window[symId+'_opt']; 
        let $e = $(expId).empty(); 
        if(l) l.forEach(d => $e.append(`<option value="${d}">${d}</option>`)); 
        if(expId === '#exp') fillChain('#sym', '#exp', '#type', '#str');
        if(expId === '#h_exp') fillChain('#h_sym', '#h_exp', '#h_type', '#h_str');
    }
    $('#type').change(() => fillExp('#exp', '#type', '#sym'));
    $('#h_type').change(() => fillExp('#h_exp', '#h_type', '#h_sym'));

    function fillChain(sym, exp, type, str) {
        let spot = symLTP[sym] || 0;
        $.get(`/api/chain?symbol=${$(sym).val()}&expiry=${$(exp).val()}&type=${$(type).val()}&ltp=${spot}`, d => {
            let $s = $(str).empty(); 
            d.forEach(r => $s.append(`<option value="${r.strike}" ${r.label.includes('ATM')?'selected':''}>${r.strike} ${r.label}</option>`));
            if(str === '#str') fetchLTP();
        });
    }
    $('#exp').change(() => fillChain('#sym', '#exp', '#type', '#str'));
    $('#h_exp').change(() => fillChain('#h_sym', '#h_exp', '#h_type', '#h_str'));

    // --- TRADE TAB P&L ---
    $('#str').change(fetchLTP);
    function fetchLTP() {
        $.get(`/api/specific_ltp?symbol=${$('#sym').val()}&expiry=${$('#exp').val()}&strike=${$('#str').val()}&type=${$('#type').val()}`, d => {
            curLTP=d.ltp; $('#inst_ltp').text("LTP: "+curLTP); $('#lim_pr').val(curLTP); calcRisk();
        });
    }
    $('#sl_pts, #qty').on('input', calcRisk);
    function calcRisk() {
        let p = parseFloat($('#sl_pts').val())||0;
        let qty = parseInt($('#qty').val())||1;
        let sl = curLTP - p;
        let t1 = curLTP + p*0.5;
        let t2 = curLTP + p*1.0;
        let t3 = curLTP + p*2.0;

        $('#p_sl').val(sl.toFixed(2)); 
        $('#p_t1').val(t1.toFixed(2)); 
        $('#p_t2').val(t2.toFixed(2)); 
        $('#p_t3').val(t3.toFixed(2));

        // Update P&L Labels
        $('#pnl_sl').text(`‚Çπ ${((sl-curLTP)*qty).toFixed(0)}`).css('color', 'red');
        $('#pnl_t1').text(`‚Çπ ${((t1-curLTP)*qty).toFixed(0)}`);
        $('#pnl_t2').text(`‚Çπ ${((t2-curLTP)*qty).toFixed(0)}`);
        $('#pnl_t3').text(`‚Çπ ${((t3-curLTP)*qty).toFixed(0)}`);
    }

    // --- SIMULATOR P&L ---
    $('#h_entry, #h_sl_pts, #h_qty').on('input', function() {
        let entry = parseFloat($('#h_entry').val()) || 0;
        let pts = parseFloat($('#h_sl_pts').val()) || 0;
        let qty = parseInt($('#h_qty').val()) || 1;
        
        if(entry > 0) {
            let t1 = entry + pts * 0.5;
            let t2 = entry + pts * 1.0;
            let t3 = entry + pts * 2.0;
            let sl = entry - pts;

            $('#h_t1').val(t1.toFixed(2));
            $('#h_t2').val(t2.toFixed(2));
            $('#h_t3').val(t3.toFixed(2));

            // Update Simulator P&L Labels
            $('#h_pnl_sl').text(`‚Çπ ${((sl-entry)*qty).toFixed(0)}`);
            $('#h_pnl_t1').text(`‚Çπ ${((t1-entry)*qty).toFixed(0)}`);
            $('#h_pnl_t2').text(`‚Çπ ${((t2-entry)*qty).toFixed(0)}`);
            $('#h_pnl_t3').text(`‚Çπ ${((t3-entry)*qty).toFixed(0)}`);
        }
    });

    window.checkHistory = function() {
        let entry = $('#h_entry').val();
        if(!entry) { alert("Entry Price required!"); return; }
        let d = {
            symbol:$('#h_sym').val(), type:$('#h_type').val(), expiry:$('#h_exp').val(), 
            strike:$('#h_str').val(), time:$('#h_time').val(), 
            sl_points:$('#h_sl_pts').val(), qty:$('#h_qty').val(),
            entry_price: entry, t1: $('#h_t1').val(), t2: $('#h_t2').val(), t3: $('#h_t3').val()
        };
        $('#h_res').show().text("Simulating...");
        $.ajax({
            type: "POST", url: '/api/history_check',
            data: JSON.stringify(d), contentType: "application/json",
            success: function(r) {
                if(r.status==='success') {
                    $('#h_res').html(`<b class="text-success">${r.message}</b>`);
                    setTimeout(() => { if(r.is_active) switchTab('pos'); else switchTab('closed'); }, 1500);
                } else $('#h_res').text(r.message);
            }
        });
    };
</script>

</body>
</html>
