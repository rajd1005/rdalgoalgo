<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Algo Terminal V4.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 80px; }
        .ticker-bar { background: #111; color: #fff; padding: 8px; font-size: 0.85rem; white-space: nowrap; overflow-x: auto; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .ticker-item { margin-right: 15px; font-weight: 600; }
        .auth-btn { font-size: 0.75rem; padding: 4px 12px; border-radius: 20px; text-decoration: none; font-weight: bold; background: #dc3545; color: white; }
        .custom-card { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); background: #fff; margin-bottom: 15px; }
        .card-head { padding: 12px 15px; font-weight: 700; border-bottom: 1px solid #f0f0f0; background: #fff; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 15px; }
        .nav-tabs { border: none; background: #fff; padding: 8px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; }
        .nav-btn { flex: 1; text-align: center; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #6c757d; margin: 0 2px; font-size: 0.9rem; }
        .nav-btn.active { background-color: #0d6efd; color: #fff; }
        .pnl-green { color: #198754; font-weight: bold; font-size: 0.8rem; display: block; } 
        .pnl-red { color: #dc3545; font-weight: bold; font-size: 0.8rem; display: block; }
        .pos-grid-label { font-size: 0.7rem; color: #888; font-weight: 600; text-transform: uppercase; }
        .pos-grid-val { font-weight: 700; font-size: 0.9rem; }
        .log-entry { font-size: 0.75rem; border-left: 2px solid #ddd; padding-left: 8px; margin-bottom: 4px; color: #555; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .settings-btn { cursor: pointer; color: #0d6efd; text-decoration: underline; font-size: 0.8rem; }
        .sl-table td { vertical-align: middle; }
        .action-btn { cursor: pointer; font-size: 0.9rem; padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd; background: #f8f9fa; margin-left: 5px; text-decoration: none; color: #333; }
        .action-btn:hover { background: #e9ecef; }
    </style>
</head>
<body>

<div class="container mt-3">
    {% with messages = get_flashed_messages() %}
        {% if messages %} <div class="alert alert-info py-2 shadow-sm border-0">{{ messages[0] }}</div> {% endif %}
    {% endwith %}

    {% if not is_active %}
    <div class="custom-card p-5 text-center mt-5">
        <h2>üîå Offline</h2>
        <a href="{{ login_url }}" class="btn btn-primary btn-lg mt-3 w-100 fw-bold">Login to Zerodha</a>
    </div>
    {% else %}
    
    <div class="ticker-bar rounded mb-3 shadow-sm">
        <div>
            <span class="ticker-item">NIFTY: <span id="n_lp" class="text-warning">...</span></span>
            <span class="ticker-item">BANK: <span id="b_lp" class="text-warning">...</span></span>
        </div>
        <div>
            <span class="text-white me-3 settings-btn" data-bs-toggle="modal" data-bs-target="#settingsModal">‚öôÔ∏è Settings</span>
            <a href="/logout" class="auth-btn">Logout</a>
        </div>
    </div>

    <div class="nav-tabs">
        <div class="nav-btn active" onclick="switchTab('trade')">üöÄ Trade</div>
        <div class="nav-btn" onclick="switchTab('pos')">üíº Active</div>
        <div class="nav-btn" onclick="switchTab('closed')">üìú Closed</div>
        <div class="nav-btn" onclick="switchTab('history')">üìÖ Simulator</div>
    </div>

    <div id="trade" class="tab-content active">
        <form action="/trade" method="post">
            <div class="custom-card">
                <div class="card-head"><span>New Order</span> <span id="inst_ltp" class="badge bg-primary">LTP: 0</span></div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="pos-grid-label">SYMBOL</label>
                        <input type="text" id="sym" name="index" class="form-control fw-bold" placeholder="e.g. NIFTY" list="sym_list" required>
                        <datalist id="sym_list"></datalist>
                    </div>
                    <div class="mb-3">
                        <select name="type" id="type" class="form-select fw-bold"><option value="CE">CE</option><option value="PE">PE</option><option value="FUT">FUT</option><option value="EQ">EQ</option></select>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><select name="expiry" id="exp" class="form-select"></select></div>
                        <div class="col-6"><select name="strike" id="str" class="form-select"></select></div>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="pos-grid-label">QTY (<span id="lot">1</span> x <span id="qty_mult_disp">1</span>)</label>
                            <input type="number" name="qty" id="qty" class="form-control fw-bold" value="1">
                        </div>
                        <div class="col-6"><label class="pos-grid-label">ORDER</label><select name="order_type" id="ord" class="form-select fw-bold"><option value="LIMIT">LIMIT</option><option value="MARKET">MARKET</option></select></div>
                    </div>
                    
                    <div id="lim_box" class="mb-3">
                        <label class="pos-grid-label">LIMIT PRICE</label>
                        <input type="number" step="0.05" name="limit_price" id="lim_pr" class="form-control mb-3 text-primary fw-bold" placeholder="Limit Price">
                    </div>
                </div>
            </div>

            <div class="custom-card">
                <div class="card-head">üõ°Ô∏è Projected P&L</div>
                <div class="card-body">
                    <div class="input-group mb-3"><span class="input-group-text">SL Pts</span><input type="number" id="sl_pts" name="sl_points" class="form-control fw-bold text-center" value="20"></div>
                    <div class="row g-2 text-center">
                        <div class="col-3">
                            <small class="text-danger fw-bold">SL</small>
                            <input type="text" id="p_sl" class="form-control text-center text-danger fw-bold mb-1" readonly>
                            <span id="pnl_sl" class="pnl-red">‚Çπ 0</span>
                        </div>
                        <div class="col-3">
                            <small class="text-success fw-bold">T1 (<span id="r_t1">0.5</span>x)</small>
                            <input type="text" id="p_t1" name="t1_price" class="form-control text-center text-success fw-bold mb-1">
                            <span id="pnl_t1" class="pnl-green">‚Çπ 0</span>
                        </div>
                        <div class="col-3">
                            <small class="text-success fw-bold">T2 (<span id="r_t2">1.0</span>x)</small>
                            <input type="text" id="p_t2" name="t2_price" class="form-control text-center text-success fw-bold mb-1">
                            <span id="pnl_t2" class="pnl-green">‚Çπ 0</span>
                        </div>
                        <div class="col-3">
                            <small class="text-success fw-bold">T3 (<span id="r_t3">1.5</span>x)</small>
                            <input type="text" id="p_t3" name="t3_price" class="form-control text-center text-success fw-bold mb-1">
                            <span id="pnl_t3" class="pnl-green">‚Çπ 0</span>
                        </div>
                    </div>
                </div>
            </div>

            <input type="hidden" name="mode" id="mode_input" value="PAPER">
            <div class="d-flex gap-2 mb-3">
                <div class="btn btn-outline-warning w-50 fw-bold active" onclick="setMode(this, 'PAPER')">PAPER</div>
                <div class="btn btn-outline-danger w-50 fw-bold" onclick="setMode(this, 'LIVE')">LIVE</div>
            </div>
            <button type="submit" class="btn btn-dark w-100 py-3 fw-bold rounded-pill shadow">üöÄ EXECUTE</button>
        </form>
    </div>

    <div id="pos" class="tab-content">
        <div class="row g-2 mb-3">
            <div class="col-4">
                <div class="card text-center border-danger shadow-sm">
                    <div class="card-body p-2"><small class="text-danger fw-bold">LIVE P&L</small><div id="sum_live" class="fw-bold">‚Çπ 0</div></div>
                </div>
            </div>
            <div class="col-4">
                <div class="card text-center border-warning shadow-sm">
                    <div class="card-body p-2"><small class="text-warning text-dark fw-bold">PAPER P&L</small><div id="sum_paper" class="fw-bold">‚Çπ 0</div></div>
                </div>
            </div>
            <div class="col-4">
                <div class="card text-center border-info shadow-sm">
                    <div class="card-body p-2"><small class="text-info text-dark fw-bold">SIM P&L</small><div id="sum_sim" class="fw-bold">‚Çπ 0</div></div>
                </div>
            </div>
        </div>

        <div class="custom-card">
            <div class="card-head d-flex justify-content-between align-items-center">
                <span>üíº Active Positions</span>
                <select id="active_filter" class="form-select form-select-sm" style="width: auto; font-weight: bold;">
                    <option value="ALL">All Trades</option>
                    <option value="LIVE">Live</option>
                    <option value="PAPER">Paper</option>
                    <option value="SIMULATOR">Simulator</option>
                </select>
            </div>
            <div class="card-body p-2" id="pos-container">
                <div class="text-center p-4 text-muted">Loading...</div>
            </div>
        </div>
    </div>

    <div id="closed" class="tab-content">
        <div class="custom-card">
            <div class="card-head d-flex justify-content-between">
                <span>üìú History</span>
                <div class="d-flex align-items-center">
                    <select id="hist_filter" class="form-select form-select-sm me-2" style="width: auto; font-weight: bold;">
                        <option value="ALL">All Trades</option>
                        <option value="LIVE">Live</option>
                        <option value="PAPER">Paper</option>
                        <option value="SIMULATOR">Simulator</option>
                    </select>
                    <input type="date" id="hist_date" class="form-control form-control-sm me-2" style="width: 130px;">
                    <span id="day_pnl" class="badge bg-secondary">‚Çπ 0</span>
                </div>
            </div>
            <div class="card-body p-2" id="hist-container">
                <div class="text-center p-4 text-muted">Loading...</div>
            </div>
        </div>
    </div>

    <div id="history" class="tab-content">
        <div class="custom-card">
            <div class="card-head">üìÖ Trade Simulator</div>
            <div class="card-body">
                <div class="mb-3"><label class="pos-grid-label">SEARCH SYMBOL</label><input type="text" id="h_sym" class="form-control fw-bold" placeholder="Symbol" list="h_sym_list"><datalist id="h_sym_list"></datalist></div>
                <div class="row g-2 mb-3">
                    <div class="col-4"><select id="h_type" class="form-select"><option>CE</option><option>PE</option><option>FUT</option></select></div>
                    <div class="col-8"><select id="h_exp" class="form-select"></select></div>
                </div>
                <select id="h_str" class="form-select mb-3"><option>Select Expiry First</option></select>
                <div class="row g-2 mb-3">
                    <div class="col-6"><label class="pos-grid-label">ENTRY PRICE <span class="text-danger">*</span></label><input type="number" step="0.05" id="h_entry" class="form-control fw-bold border-primary" placeholder="Required"></div>
                    <div class="col-6"><label class="pos-grid-label">ENTRY TIME</label><input type="datetime-local" id="h_time" class="form-control"></div>
                </div>
                <div class="p-2 bg-light rounded border mb-3">
                    <div class="row g-2 align-items-end mb-2">
                        <div class="col-6"><label class="pos-grid-label">SL Points</label><input type="number" id="h_sl_pts" class="form-control" value="20"></div>
                        <div class="col-6"><label class="pos-grid-label">Qty (Mult: <span id="h_qty_mult">1</span>)</label><input type="number" id="h_qty" class="form-control fw-bold" value="50"></div>
                    </div>
                    <hr class="my-2">
                    <div class="row g-2 text-center">
                        <div class="col-4"><small class="text-success fw-bold">T1 (<span id="hr_t1">0.5</span>x)</small><input type="number" step="0.05" id="h_t1" class="form-control form-control-sm mb-1"><span id="h_pnl_t1" class="pnl-green">‚Çπ 0</span></div>
                        <div class="col-4"><small class="text-success fw-bold">T2 (<span id="hr_t2">1.0</span>x)</small><input type="number" step="0.05" id="h_t2" class="form-control form-control-sm mb-1"><span id="h_pnl_t2" class="pnl-green">‚Çπ 0</span></div>
                        <div class="col-4"><small class="text-success fw-bold">T3 (<span id="hr_t3">1.5</span>x)</small><input type="number" step="0.05" id="h_t3" class="form-control form-control-sm mb-1"><span id="h_pnl_t3" class="pnl-green">‚Çπ 0</span></div>
                    </div>
                    <div class="mt-2 text-center"><small class="text-danger fw-bold">Potential Loss: </small><span id="h_pnl_sl" class="pnl-red" style="display:inline;">‚Çπ 0</span></div>
                </div>
                <button onclick="checkHistory()" class="btn btn-info w-100 fw-bold text-white">üîÑ Run Simulation</button>
                <div id="h_res" class="mt-3 p-3 bg-light border rounded" style="display:none;"></div>
            </div>
        </div>
    </div>

    {% endif %}
</div>

<div class="modal fade" id="editTradeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">‚úèÔ∏è Edit Trade Protection</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="edit_trade_id">
        <label class="pos-grid-label">New Stop Loss</label>
        <input type="number" step="0.05" id="edit_sl" class="form-control mb-3 text-danger fw-bold">
        
        <label class="pos-grid-label">New Targets</label>
        <div class="input-group mb-2">
            <span class="input-group-text text-success">T1</span><input type="number" step="0.05" id="edit_t1" class="form-control">
        </div>
        <div class="input-group mb-2">
            <span class="input-group-text text-success">T2</span><input type="number" step="0.05" id="edit_t2" class="form-control">
        </div>
        <div class="input-group mb-2">
            <span class="input-group-text text-success">T3</span><input type="number" step="0.05" id="edit_t3" class="form-control">
        </div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-primary w-100" onclick="saveTradeUpdate()">üíæ Update Protection</button></div>
    </div>
  </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">‚öôÔ∏è Global Settings</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        
        <label class="pos-grid-label">Default Stop Loss Points (Symbol Specific)</label>
        <div class="input-group mb-2"><input type="text" id="set_sym" class="form-control" placeholder="Symbol"><input type="number" id="set_sl" class="form-control" placeholder="SL Pts"><button class="btn btn-primary" onclick="saveSymSL()">Add</button></div>
        <div class="table-responsive mb-3" style="max-height: 150px; overflow-y: auto;">
            <table class="table table-bordered table-sm mt-2 sl-table"><thead class="table-light"><tr><th>Symbol</th><th>SL</th><th>Action</th></tr></thead><tbody id="sl_table_body"></tbody></table>
        </div>

        <ul class="nav nav-tabs mb-3" id="settingTabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-paper">Paper</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-live">Live</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-sim">Simulator</button></li>
        </ul>

        <div class="tab-content" id="settingTabsContent">
            <div class="tab-pane fade show active" id="tab-paper">
                <h6>Paper Trade Config</h6>
                <label class="pos-grid-label">Quantity Multiplier</label><input type="number" id="paper_qty_mult" class="form-control mb-2" value="1" min="1">
                <label class="pos-grid-label">Target Ratios</label>
                <div class="input-group mb-2">
                    <span class="input-group-text">T1</span><input type="number" step="0.1" id="paper_r1" class="form-control" value="0.5">
                    <span class="input-group-text">T2</span><input type="number" step="0.1" id="paper_r2" class="form-control" value="1.0">
                    <span class="input-group-text">T3</span><input type="number" step="0.1" id="paper_r3" class="form-control" value="1.5">
                </div>
            </div>
            <div class="tab-pane fade" id="tab-live">
                <h6>Live Trade Config</h6>
                <label class="pos-grid-label">Quantity Multiplier</label><input type="number" id="live_qty_mult" class="form-control mb-2" value="1" min="1">
                <label class="pos-grid-label">Target Ratios</label>
                <div class="input-group mb-2">
                    <span class="input-group-text">T1</span><input type="number" step="0.1" id="live_r1" class="form-control" value="0.5">
                    <span class="input-group-text">T2</span><input type="number" step="0.1" id="live_r2" class="form-control" value="1.0">
                    <span class="input-group-text">T3</span><input type="number" step="0.1" id="live_r3" class="form-control" value="1.5">
                </div>
            </div>
            <div class="tab-pane fade" id="tab-sim">
                <h6>Simulator Config</h6>
                <label class="pos-grid-label">Quantity Multiplier</label><input type="number" id="sim_qty_mult" class="form-control mb-2" value="1" min="1">
                <label class="pos-grid-label">Target Ratios</label>
                <div class="input-group mb-2">
                    <span class="input-group-text">T1</span><input type="number" step="0.1" id="sim_r1" class="form-control" value="0.5">
                    <span class="input-group-text">T2</span><input type="number" step="0.1" id="sim_r2" class="form-control" value="1.0">
                    <span class="input-group-text">T3</span><input type="number" step="0.1" id="sim_r3" class="form-control" value="1.5">
                </div>
            </div>
        </div>

      </div>
      <div class="modal-footer"><button type="button" class="btn btn-primary w-100" onclick="saveSettings()">Save Changes</button></div>
    </div>
  </div>
</div>

<script>
    let settings = { 
        modes: {
            LIVE: {qty_mult: 1, ratios: [0.5, 1.0, 1.5]},
            PAPER: {qty_mult: 1, ratios: [0.5, 1.0, 1.5]},
            SIMULATOR: {qty_mult: 1, ratios: [0.5, 1.0, 1.5]}
        }, 
        symbol_sl: {} 
    };

    function loadSettings() {
        $.get('/api/settings/load', function(data) {
            if(data) {
                settings = data;
                // Ensure structure
                if(!settings.modes) {
                    // Fallback if old data format returned
                    let oldM = settings.qty_mult || 1;
                    let oldR = settings.ratios || [0.5, 1.0, 1.5];
                    settings.modes = {
                        LIVE: {qty_mult: oldM, ratios: oldR},
                        PAPER: {qty_mult: oldM, ratios: oldR},
                        SIMULATOR: {qty_mult: oldM, ratios: oldR}
                    };
                }

                // Populate Modal Inputs
                ['PAPER', 'LIVE', 'SIMULATOR'].forEach(m => {
                    let k = m === 'SIMULATOR' ? 'sim' : m.toLowerCase();
                    $(`#${k}_qty_mult`).val(settings.modes[m].qty_mult);
                    $(`#${k}_r1`).val(settings.modes[m].ratios[0]);
                    $(`#${k}_r2`).val(settings.modes[m].ratios[1]);
                    $(`#${k}_r3`).val(settings.modes[m].ratios[2]);
                });

                updateSymList();
                updateDisplayValues(); // Update Main UI based on current selection
            }
        });
    }

    function saveSettings() {
        // Read from Modal
        settings.modes.PAPER.qty_mult = parseInt($('#paper_qty_mult').val()) || 1;
        settings.modes.PAPER.ratios = [parseFloat($('#paper_r1').val()), parseFloat($('#paper_r2').val()), parseFloat($('#paper_r3').val())];
        
        settings.modes.LIVE.qty_mult = parseInt($('#live_qty_mult').val()) || 1;
        settings.modes.LIVE.ratios = [parseFloat($('#live_r1').val()), parseFloat($('#live_r2').val()), parseFloat($('#live_r3').val())];
        
        settings.modes.SIMULATOR.qty_mult = parseInt($('#sim_qty_mult').val()) || 1;
        settings.modes.SIMULATOR.ratios = [parseFloat($('#sim_r1').val()), parseFloat($('#sim_r2').val()), parseFloat($('#sim_r3').val())];

        $.ajax({ type: "POST", url: '/api/settings/save', data: JSON.stringify(settings), contentType: "application/json", success: () => { $('#settingsModal').modal('hide'); loadSettings(); } });
    }

    function updateDisplayValues() {
        // Determine active mode based on UI state
        let mode = 'PAPER';
        if ($('#history').is(':visible')) {
            mode = 'SIMULATOR';
        } else {
            mode = $('#mode_input').val(); // 'LIVE' or 'PAPER'
        }
        
        let s = settings.modes[mode];
        if(!s) return;

        // Update Multiplier Display
        $('#qty_mult_disp').text(s.qty_mult); 
        $('#h_qty_mult').text(settings.modes.SIMULATOR.qty_mult);

        // Update Ratio Displays
        $('#r_t1').text(s.ratios[0]); $('#hr_t1').text(settings.modes.SIMULATOR.ratios[0]);
        $('#r_t2').text(s.ratios[1]); $('#hr_t2').text(settings.modes.SIMULATOR.ratios[1]);
        $('#r_t3').text(s.ratios[2]); $('#hr_t3').text(settings.modes.SIMULATOR.ratios[2]);
        
        // Trigger recalc
        calcRisk();
        // Also trigger simulator recalc if visible
        if ($('#history').is(':visible')) {
             let entry = parseFloat($('#h_entry').val()) || 0;
             if (entry > 0) $('#h_entry').trigger('input');
        }
    }

    function saveSymSL() { let s=$('#set_sym').val().toUpperCase(); let p=parseInt($('#set_sl').val()); if(s && p) { settings.symbol_sl[s]=p; updateSymList(); $('#set_sym').val(''); $('#set_sl').val(''); } }
    function updateSymList() { let tbody=$('#sl_table_body').empty(); Object.keys(settings.symbol_sl).forEach(sym => { tbody.append(`<tr><td class="fw-bold">${sym}</td><td>${settings.symbol_sl[sym]}</td><td><button class="btn btn-sm btn-outline-secondary py-0" onclick="editSymSL('${sym}')">‚úèÔ∏è</button> <button class="btn btn-sm btn-outline-danger py-0" onclick="deleteSymSL('${sym}')">üóëÔ∏è</button></td></tr>`); }); }
    function editSymSL(sym) { $('#set_sym').val(sym); $('#set_sl').val(settings.symbol_sl[sym]); }
    function deleteSymSL(sym) { delete settings.symbol_sl[sym]; updateSymList(); }
    
    $(document).ready(function() {
        loadSettings();
        
        let now = new Date();
        const offset = now.getTimezoneOffset();
        let localDate = new Date(now.getTime() - (offset*60*1000));
        let dateStr = localDate.toISOString().slice(0,10);
        let timeStr = localDate.toISOString().slice(0,16);

        $('#hist_date').val(dateStr);
        $('#h_time').val(timeStr);
        
        $('#hist_date, #hist_filter').change(loadClosedTrades);
        $('#active_filter').change(updateData);
    });

    function switchTab(id) { 
        $('.tab-content').hide(); 
        $(`#${id}`).show(); 
        $('.nav-btn').removeClass('active'); 
        $(event.target).addClass('active'); 
        if(id==='closed') loadClosedTrades(); 
        updateDisplayValues(); 
    }
    
    function setMode(el, mode) { 
        $('#mode_input').val(mode); 
        $(el).parent().find('.btn').removeClass('active'); 
        $(el).addClass('active'); 
        updateDisplayValues();
        // Reload details to apply new multiplier to Quantity field
        loadDetails('#sym', '#exp', '#type', '#qty', '#sl_pts');
    }

    function getTradeCategory(t) {
        if (t.order_type === 'SIMULATION') return 'SIMULATOR';
        if (t.mode === 'LIVE') return 'LIVE';
        return 'PAPER';
    }

    function getMarkBadge(category) {
        if (category === 'SIMULATOR') return '<span class="badge bg-info text-dark">SIMULATOR</span>';
        if (category === 'LIVE') return '<span class="badge bg-danger">LIVE</span>';
        return '<span class="badge bg-warning text-dark">PAPER</span>';
    }

    let curLTP=0; let symLTP={};
    let activeTradesList = []; 

    function updateData() {
        if(!document.getElementById('n_lp')) return;
        $.get('/api/indices', d => { $('#n_lp').text(d.NIFTY); $('#b_lp').text(d.BANKNIFTY); });
        
        let currentSym = $('#sym').val();
        if(currentSym && $('#trade').is(':visible')) {
             $.get(`/api/specific_ltp?symbol=${currentSym}&expiry=${$('#exp').val()}&strike=${$('#str').val()}&type=${$('#type').val()}`, d => {
                curLTP=d.ltp; $('#inst_ltp').text("LTP: "+curLTP);
             });
        }

        let filterType = $('#active_filter').val();

        $.get('/api/positions', trades => {
            activeTradesList = trades; 

            // Calculate Totals Separately
            let sumLive = 0, sumPaper = 0, sumSim = 0;
            trades.forEach(t => {
                let pnl = (t.status === 'PENDING') ? 0 : (t.current_ltp - t.entry_price) * t.quantity;
                let cat = getTradeCategory(t);
                if(cat === 'LIVE') sumLive += pnl;
                else if(cat === 'PAPER') sumPaper += pnl;
                else if(cat === 'SIMULATOR') sumSim += pnl;
            });
            
            // Update Summary Display
            $('#sum_live').text("‚Çπ " + sumLive.toFixed(2)).attr('class', sumLive >= 0 ? 'fw-bold text-success' : 'fw-bold text-danger');
            $('#sum_paper').text("‚Çπ " + sumPaper.toFixed(2)).attr('class', sumPaper >= 0 ? 'fw-bold text-success' : 'fw-bold text-danger');
            $('#sum_sim').text("‚Çπ " + sumSim.toFixed(2)).attr('class', sumSim >= 0 ? 'fw-bold text-success' : 'fw-bold text-danger');

            // Filter Active Trades
            let filtered = trades.filter(t => filterType === 'ALL' || getTradeCategory(t) === filterType);
            
            let html = '';
            if(filtered.length === 0) html = '<div class="text-center p-4 text-muted">No Active Trades for selected filter</div>';
            else {
                filtered.forEach(t => {
                    let pnl = (t.current_ltp - t.entry_price) * t.quantity;
                    let color = pnl >= 0 ? 'pnl-green' : 'pnl-red';
                    if (t.status === 'PENDING') { pnl = 0; color = 'text-warning'; }
                    
                    let cat = getTradeCategory(t);
                    let badge = getMarkBadge(cat);
                    
                    // Add Edit Button for Live/Paper
                    let editBtn = '';
                    if (cat !== 'SIMULATOR') {
                         editBtn = `<span class="action-btn text-primary" onclick="openEditTradeModal('${t.id}')">‚úèÔ∏è</span>`;
                    }

                    html += `<div class="card mb-3 border shadow-sm"><div class="card-body p-3">
                        <div class="d-flex justify-content-between mb-2"><h6 class="fw-bold mb-0">${t.symbol} <span class="badge bg-light text-dark border ms-2">Qty: ${t.quantity}</span></h6><div>${editBtn} ${badge}</div></div>
                        <div class="text-center py-2 bg-light rounded mb-3"><small class="text-muted fw-bold">P&L</small><h3 class="mb-0 fw-bold ${color}">${t.status==='PENDING'?'PENDING':pnl.toFixed(2)}</h3></div>
                        <div class="row text-center mb-2"><div class="col-6 border-end"><div class="pos-grid-label">Entry</div><div class="pos-grid-val">${t.entry_price.toFixed(2)}</div></div><div class="col-6"><div class="pos-grid-label">LTP</div><div class="pos-grid-val text-primary">${t.current_ltp.toFixed(2)}</div></div></div>
                        <div class="row text-center border-top pt-2"><div class="col-3"><div class="pos-grid-label text-danger">SL</div><small class="fw-bold">${t.sl.toFixed(1)}</small></div><div class="col-3"><div class="pos-grid-label text-success">T1</div><small class="fw-bold">${t.targets[0].toFixed(1)}</small></div><div class="col-3"><div class="pos-grid-label text-success">T2</div><small class="fw-bold">${t.targets[1].toFixed(1)}</small></div><div class="col-3"><div class="pos-grid-label text-success">T3</div><small class="fw-bold">${t.targets[2].toFixed(1)}</small></div></div>
                        <div class="mt-3 d-flex justify-content-between"><a href="/close_trade/${t.id}" class="btn btn-sm btn-dark w-100 fw-bold">${t.status==='PENDING'?'Cancel Order':'Exit Position'}</a>${t.mode=='PAPER' ? `<a href="/promote/${t.id}" class="btn btn-sm btn-outline-danger ms-2 fw-bold">Live</a>` : ''}</div></div></div>`;
                });
            }
            $('#pos-container').html(html);
        });
    }
    setInterval(updateData, 2000); updateData();

    // Edit Modal Logic
    function openEditTradeModal(id) {
        let t = activeTradesList.find(x => x.id == id);
        if(!t) return;
        
        $('#edit_trade_id').val(t.id);
        $('#edit_sl').val(t.sl);
        $('#edit_t1').val(t.targets[0] || 0);
        $('#edit_t2').val(t.targets[1] || 0);
        $('#edit_t3').val(t.targets[2] || 0);
        
        var myModal = new bootstrap.Modal(document.getElementById('editTradeModal'));
        myModal.show();
    }

    function saveTradeUpdate() {
        let d = {
            id: $('#edit_trade_id').val(),
            sl: parseFloat($('#edit_sl').val()),
            targets: [
                parseFloat($('#edit_t1').val()) || 0,
                parseFloat($('#edit_t2').val()) || 0,
                parseFloat($('#edit_t3').val()) || 0
            ]
        };
        $.ajax({
            type: "POST", url: '/api/update_trade',
            data: JSON.stringify(d), contentType: "application/json",
            success: function(r) {
                if(r.status==='success') {
                    $('#editTradeModal').modal('hide');
                    updateData();
                } else alert("Failed to update: " + r.message);
            }
        });
    }

    let allClosedTrades = [];
    function loadClosedTrades() {
        let filterDate = $('#hist_date').val();
        let filterType = $('#hist_filter').val();

        $.get('/api/closed_trades', trades => {
            allClosedTrades = trades; 
            let html = '';
            let dayTotal = 0;
            
            let filtered = trades.filter(t => {
                let matchDate = t.exit_time && t.exit_time.startsWith(filterDate);
                let matchType = (filterType === 'ALL' || getTradeCategory(t) === filterType);
                return matchDate && matchType;
            });
            
            if(filtered.length === 0) html = '<div class="text-center p-4 text-muted">No History for this Date/Filter</div>';
            else {
                filtered.forEach(t => {
                    dayTotal += t.pnl;
                    let color = t.pnl >= 0 ? 'pnl-green' : 'pnl-red';
                    let logs = t.logs ? t.logs.map(l => `<div class="log-entry">${l}</div>`).join('') : '';
                    
                    let cat = getTradeCategory(t);
                    let badge = getMarkBadge(cat);
                    
                    let editBtn = (t.order_type === 'SIMULATION') ? `<span class="action-btn text-primary" onclick="editSim('${t.id}')">‚úèÔ∏è Edit</span>` : '';
                    let delBtn = `<span class="action-btn text-danger" onclick="deleteTrade('${t.id}')">üóëÔ∏è</span>`;

                    html += `<div class="card mb-3 border shadow-sm"><div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center"><h6 class="fw-bold mb-0">${t.symbol}</h6><div>${editBtn}${delBtn}${badge}<span class="badge bg-secondary ms-1">${t.status}</span></div></div>
                        <div class="d-flex justify-content-between mt-2"><small>Entry: <b>${t.entry_price.toFixed(2)}</b></small><small>Exit: <b>${t.exit_price.toFixed(2)}</b></small></div>
                        <div class="d-flex justify-content-between mt-2 align-items-center"><small class="text-muted">${t.exit_time}</small><h5 class="mb-0 fw-bold ${color}">${t.pnl}</h5></div>
                        <div class="mt-2 pt-2 border-top bg-light p-2 rounded"><small class="fw-bold text-muted">Logs:</small>${logs}</div></div></div>`;
                });
            }
            $('#hist-container').html(html);
            $('#day_pnl').text("‚Çπ " + dayTotal.toFixed(2));
            if(dayTotal >= 0) $('#day_pnl').removeClass('bg-danger').addClass('bg-success');
            else $('#day_pnl').removeClass('bg-success').addClass('bg-danger');
        });
    }

    function deleteTrade(id) {
        if(confirm("Are you sure you want to delete this trade history?")) {
            $.ajax({
                url: '/api/delete_trade/' + id,
                type: 'POST',
                success: function(r) {
                    if(r.status === 'success') loadClosedTrades();
                    else alert('Failed to delete');
                }
            });
        }
    }

    function editSim(id) {
        let t = allClosedTrades.find(x => x.id == id);
        if(!t) return;
        
        $('.tab-content').hide(); 
        $('#history').show(); 
        $('.nav-btn').removeClass('active'); 
        $('.nav-btn').last().addClass('active');

        if(t.raw_params) {
            $('#h_sym').val(t.raw_params.symbol);
            $('#h_entry').val(t.entry_price);
            $('#h_qty').val(t.quantity);
            $('#h_time').val(t.raw_params.time);
            $('#h_type').val(t.raw_params.type);
            
            loadDetails('#h_sym', '#h_exp', '#h_type', '#h_qty', '#h_sl_pts');
            
            setTimeout(() => {
                 $('#h_exp').val(t.raw_params.expiry).change();
                 setTimeout(() => {
                     $('#h_str').val(t.raw_params.strike).change();
                 }, 500);
            }, 800);
        } else {
             $('#h_sym').val(t.symbol);
             $('#h_entry').val(t.entry_price);
             $('#h_qty').val(t.quantity);
             alert("Old trade format: Some fields might not autofill perfectly.");
        }
    }

    function bindSearch(id, listId) { $(id).on('input', function() { if(this.value.length>1) $.get('/api/search?q='+this.value, d => { $(listId).empty(); d.forEach(s=>$(listId).append(`<option value="${s}">`)) }); }); }
    bindSearch('#sym', '#sym_list'); bindSearch('#h_sym', '#h_sym_list');

    function loadDetails(symId, expId, typeId, qtyId, slId) {
        let s = $(symId).val(); if(!s) return;
        let savedSL = settings.symbol_sl[s.toUpperCase()] || 20;
        $(slId).val(savedSL);
        
        let mode = 'PAPER';
        if ($('#history').is(':visible')) mode = 'SIMULATOR';
        else mode = $('#mode_input').val();
        
        let mult = settings.modes[mode].qty_mult || 1;

        $.get('/api/details?symbol='+s, d => { 
            symLTP[symId] = d.ltp; 
            if(d.lot_size > 0) {
                let totalQty = d.lot_size * mult;
                if(symId === '#sym') { $('#lot').text(d.lot_size); }
                $(qtyId).val(totalQty).attr('step', d.lot_size).attr('min', d.lot_size);
            }
            window[symId+'_fut'] = d.fut_expiries; window[symId+'_opt'] = d.opt_expiries;
            fillExp(expId, typeId, symId);
        });
    }
    $('#sym').change(() => loadDetails('#sym', '#exp', '#type', '#qty', '#sl_pts'));
    $('#h_sym').change(() => loadDetails('#h_sym', '#h_exp', '#h_type', '#h_qty', '#h_sl_pts'));

    function fillExp(expId, typeId, symId) { 
        let l = $(typeId).val()=='FUT' ? window[symId+'_fut'] : window[symId+'_opt']; 
        let $e = $(expId).empty(); 
        if(l) l.forEach(d => $e.append(`<option value="${d}">${d}</option>`)); 
        if(expId === '#exp') fillChain('#sym', '#exp', '#type', '#str');
        if(expId === '#h_exp') fillChain('#h_sym', '#h_exp', '#h_type', '#h_str');
    }
    $('#type').change(() => fillExp('#exp', '#type', '#sym'));
    $('#h_type').change(() => fillExp('#h_exp', '#h_type', '#h_sym'));

    function fillChain(sym, exp, type, str) {
        let spot = symLTP[sym] || 0;
        $.get(`/api/chain?symbol=${$(sym).val()}&expiry=${$(exp).val()}&type=${$(type).val()}&ltp=${spot}`, d => {
            let $s = $(str).empty(); 
            d.forEach(r => $s.append(`<option value="${r.strike}" ${r.label.includes('ATM')?'selected':''}>${r.strike} ${r.label}</option>`));
            if(str === '#str') fetchLTP();
        });
    }
    $('#exp').change(() => fillChain('#sym', '#exp', '#type', '#str'));
    $('#h_exp').change(() => fillChain('#h_sym', '#h_exp', '#h_type', '#h_str'));

    $('#ord').change(function() {
        if($(this).val() === 'LIMIT') $('#lim_box').show(); else $('#lim_box').hide();
    });

    $('#str').change(fetchLTP);
    function fetchLTP() {
        $.get(`/api/specific_ltp?symbol=${$('#sym').val()}&expiry=${$('#exp').val()}&strike=${$('#str').val()}&type=${$('#type').val()}`, d => {
            curLTP=d.ltp; $('#inst_ltp').text("LTP: "+curLTP); 
            if ($('#ord').val() === 'LIMIT' && $('#lim_pr').val() == "") $('#lim_pr').val(curLTP);
            calcRisk();
        });
    }
    $('#sl_pts, #qty, #lim_pr, #ord').on('input change', calcRisk);
    function calcRisk() {
        let p = parseFloat($('#sl_pts').val())||0;
        let qty = parseInt($('#qty').val())||1;
        let basePrice = ($('#ord').val() === 'LIMIT' && $('#lim_pr').val() > 0) ? parseFloat($('#lim_pr').val()) : curLTP;
        
        let mode = $('#mode_input').val(); // LIVE or PAPER
        let ratios = settings.modes[mode].ratios;

        let sl = basePrice - p;
        let t1 = basePrice + p * ratios[0];
        let t2 = basePrice + p * ratios[1];
        let t3 = basePrice + p * ratios[2];

        $('#p_sl').val(sl.toFixed(2)); 
        $('#p_t1').val(t1.toFixed(2)); 
        $('#p_t2').val(t2.toFixed(2)); 
        $('#p_t3').val(t3.toFixed(2));

        $('#pnl_sl').text(`‚Çπ ${((sl-basePrice)*qty).toFixed(0)}`);
        $('#pnl_t1').text(`‚Çπ ${((t1-basePrice)*qty).toFixed(0)}`);
        $('#pnl_t2').text(`‚Çπ ${((t2-basePrice)*qty).toFixed(0)}`);
        $('#pnl_t3').text(`‚Çπ ${((t3-basePrice)*qty).toFixed(0)}`);
    }

    $('#h_entry, #h_sl_pts, #h_qty').on('input', function() {
        let entry = parseFloat($('#h_entry').val()) || 0;
        let pts = parseFloat($('#h_sl_pts').val()) || 0;
        let qty = parseInt($('#h_qty').val()) || 1;
        let ratios = settings.modes.SIMULATOR.ratios;

        if(entry > 0) {
            let sl = entry - pts;
            let t1 = entry + pts * ratios[0];
            let t2 = entry + pts * ratios[1];
            let t3 = entry + pts * ratios[2];
            $('#h_t1').val(t1.toFixed(2)); $('#h_t2').val(t2.toFixed(2)); $('#h_t3').val(t3.toFixed(2));
            $('#h_pnl_sl').text(`‚Çπ ${((sl-entry)*qty).toFixed(0)}`);
            $('#h_pnl_t1').text(`‚Çπ ${((t1-entry)*qty).toFixed(0)}`);
            $('#h_pnl_t2').text(`‚Çπ ${((t2-entry)*qty).toFixed(0)}`);
            $('#h_pnl_t3').text(`‚Çπ ${((t3-entry)*qty).toFixed(0)}`);
        }
    });

    window.checkHistory = function() {
        let entry = $('#h_entry').val();
        if(!entry) { alert("Entry Price required!"); return; }
        let d = {
            symbol:$('#h_sym').val(), type:$('#h_type').val(), expiry:$('#h_exp').val(), 
            strike:$('#h_str').val(), time:$('#h_time').val(), 
            sl_points:$('#h_sl_pts').val(), qty:$('#h_qty').val(),
            entry_price: entry, t1: $('#h_t1').val(), t2: $('#h_t2').val(), t3: $('#h_t3').val()
        };
        $('#h_res').show().text("Simulating...");
        $.ajax({
            type: "POST", url: '/api/history_check',
            data: JSON.stringify(d), contentType: "application/json",
            success: function(r) {
                if(r.status==='success') {
                    $('#h_res').html(`<b class="text-success">${r.message}</b>`);
                    setTimeout(() => { if(r.is_active) switchTab('pos'); else switchTab('closed'); }, 1500);
                } else $('#h_res').text(r.message);
            }
        });
    };
</script>

</body>
</html>
