<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Algo Trader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { border-radius: 15px 15px 0 0 !important; font-weight: 700; padding: 15px; }
        .btn-xl { padding: 15px; font-size: 1.2rem; font-weight: bold; border-radius: 10px; width: 100%; }
        .form-control, .form-select { height: 45px; border-radius: 8px; font-size: 16px; }
        .risk-input { text-align: center; font-weight: bold; }
        .nav-pills .nav-link { border-radius: 10px; font-weight: 600; padding: 12px; }
        .nav-pills .nav-link.active { background-color: #0d6efd; box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3); }
        .badge-ltp { font-size: 0.9rem; padding: 8px 12px; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark sticky-top shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">üöÄ AlgoCommander</a>
    <span class="badge {{ 'bg-success' if is_active else 'bg-danger' }} rounded-pill">
        {{ 'ONLINE' if is_active else 'OFFLINE' }}
    </span>
  </div>
</nav>

<div class="container mt-3 pb-5">
    {% if messages %}
    <div class="alert alert-info shadow-sm border-0">{{ messages[0] }}</div>
    {% endif %}

    {% if not is_active %}
    <div class="text-center mt-5">
        <div class="card p-5 shadow-lg d-inline-block">
            <h3>üîå System Offline</h3>
            <p class="text-muted">Please authenticate with Zerodha to begin.</p>
            <a href="{{ login_url }}" class="btn btn-primary btn-lg mt-3 px-5">Login to Zerodha</a>
        </div>
    </div>
    {% else %}

    <ul class="nav nav-pills nav-fill mb-4" id="pills-tab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#trade-tab">‚ö° Live Trade</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#history-tab">üìÖ History Check</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#positions-tab">üìä Positions</button>
        </li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="trade-tab">
            <form action="/trade" method="post">
                
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <span>Trade Setup</span>
                        <span id="inst-ltp" class="badge bg-light text-primary badge-ltp">LTP: 0.00</span>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            <div class="col-7">
                                <label class="text-muted small fw-bold">SYMBOL</label>
                                <input type="text" id="symbol_search" name="index" class="form-control fw-bold" placeholder="Search..." list="symbol_list" required autocomplete="off">
                                <datalist id="symbol_list"></datalist>
                            </div>
                            <div class="col-5">
                                <label class="text-muted small fw-bold">TYPE</label>
                                <select name="type" id="inst_type" class="form-select fw-bold">
                                    <option value="CE" selected>CE</option>
                                    <option value="PE">PE</option>
                                    <option value="FUT">FUT</option>
                                    <option value="EQ">EQ</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="text-muted small fw-bold">EXPIRY</label>
                                <select name="expiry" id="expiry_select" class="form-select"></select>
                            </div>
                            <div class="col-6">
                                <label class="text-muted small fw-bold">STRIKE</label>
                                <select name="strike" id="strike_select" class="form-select"></select>
                            </div>
                        </div>

                        <div class="row g-2">
                            <div class="col-6">
                                <label class="text-muted small fw-bold">QTY (Lot: <span id="lot-size">1</span>)</label>
                                <input type="number" name="qty" id="qty_input" class="form-control fw-bold" value="1">
                            </div>
                            <div class="col-6">
                                <label class="text-muted small fw-bold">ORDER</label>
                                <select name="order_type" id="order_type" class="form-select">
                                    <option value="MARKET">Market</option>
                                    <option value="LIMIT">Limit</option>
                                </select>
                            </div>
                        </div>

                        <div class="mt-2" id="limit_div" style="display:none;">
                            <label class="text-muted small fw-bold">LIMIT PRICE</label>
                            <input type="number" step="0.05" name="limit_price" id="limit_price" class="form-control" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="card border-0">
                    <div class="card-header bg-dark text-white">üõ°Ô∏è Risk Manager</div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <span class="input-group-text fw-bold">SL Points</span>
                            <input type="number" id="sl_points" name="sl_points" class="form-control fw-bold" value="20">
                        </div>

                        <div class="row g-2">
                            <div class="col-4">
                                <label class="small text-danger fw-bold">STOP LOSS</label>
                                <input type="number" step="0.05" id="sl_price" name="sl_price" class="form-control risk-input text-danger">
                            </div>
                            <div class="col-4">
                                <label class="small text-success fw-bold">TARGET 1</label>
                                <input type="number" step="0.05" id="t1_price" name="t1_price" class="form-control risk-input text-success">
                            </div>
                            <div class="col-4">
                                <label class="small text-success fw-bold">TARGET 2</label>
                                <input type="number" step="0.05" id="t2_price" name="t2_price" class="form-control risk-input text-success">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 mb-5">
                    <select name="mode" class="form-select text-center fw-bold border-warning text-uppercase">
                        <option value="PAPER">üìù Paper Mode</option>
                        <option value="LIVE">üî¥ Live Trade</option>
                    </select>
                    <button type="submit" class="btn btn-warning btn-xl shadow text-uppercase">üöÄ Execute Trade</button>
                </div>
            </form>
        </div>

        <div class="tab-pane fade" id="history-tab">
            <div class="card p-4">
                <h5 class="fw-bold">üìÖ Historical Checker (IST)</h5>
                <p class="text-muted small">Check past prices for options/futures.</p>
                
                <form id="historyForm">
                    <div class="mb-3">
                        <label class="fw-bold small">SYMBOL</label>
                        <input type="text" id="hist_symbol" class="form-control" placeholder="e.g. NIFTY" list="symbol_list" required>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="fw-bold small">TYPE</label>
                            <select id="hist_type" class="form-select">
                                <option value="CE">CE</option><option value="PE">PE</option><option value="FUT">FUT</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="fw-bold small">EXPIRY</label>
                            <select id="hist_expiry" class="form-select"><option>Select Sym</option></select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold small">STRIKE</label>
                        <input type="number" id="hist_strike" class="form-control" placeholder="Strike Price">
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold small">DATE & TIME</label>
                        <input type="datetime-local" id="hist_time" class="form-control" required>
                    </div>
                    <button type="button" class="btn btn-info w-100 fw-bold text-white" onclick="checkHistory()">üîç Check Price</button>
                </form>

                <div id="hist_result" class="mt-3 p-3 rounded bg-light border" style="display:none;"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="positions-tab">
            <div class="card p-2">
                {% for trade in trades %}
                <div class="border-bottom pb-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0 fw-bold">{{ trade.symbol }}</h6>
                        <span class="badge {{ 'bg-danger' if trade.mode == 'LIVE' else 'bg-primary' }}">{{ trade.mode }}</span>
                    </div>
                    <div class="d-flex justify-content-between small text-muted mb-2">
                        <span>Avg: {{ trade.entry_price }}</span>
                        <span class="fw-bold text-dark">LTP: {{ trade.current_ltp }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="badge bg-secondary">{{ trade.status }}</span>
                        {% if trade.mode == 'PAPER' %}
                        <a href="/promote/{{ trade.id }}" class="btn btn-sm btn-outline-danger fw-bold">Promote Live</a>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <h5>No Active Positions</h5>
                    <p>Execute a trade to see it here.</p>
                </div>
                {% endfor %}
            </div>
        </div>

    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentLTP = 0;
    
    // Toggle Limit Input
    $('#order_type').change(function() {
        $('#limit_div').slideToggle($(this).val() === 'LIMIT');
    });

    // 1. Symbol Search (Debounced)
    let searchTimeout;
    $('#symbol_search').on('input', function() {
        clearTimeout(searchTimeout);
        let val = $(this).val();
        if(val.length < 2) return;
        searchTimeout = setTimeout(() => {
            $.get('/api/search?q=' + val, (data) => {
                $('#symbol_list').empty();
                data.forEach(item => $('#symbol_list').append('<option value="' + item + '">'));
            });
        }, 300);
    });

    // 2. Fetch Details when Symbol Changed
    $('#symbol_search').change(function() {
        let sym = $(this).val();
        if(!sym) return;
        $.get('/api/details?symbol=' + sym, (data) => {
            $('#lot-size').text(data.lot_size);
            $('#qty_input').val(data.lot_size);
            
            // Store expiries globally
            window.futExps = data.fut_expiries;
            window.optExps = data.opt_expiries;
            
            populateExpiries('#inst_type', '#expiry_select');
        });
    });

    // 3. Dynamic Dropdowns
    $('#inst_type').change(() => populateExpiries('#inst_type', '#expiry_select'));
    $('#expiry_select').change(updateChain);
    $('#strike_select').change(fetchLTP);
    $('#sl_points').on('input', calcRisk);

    function populateExpiries(typeId, targetId) {
        let type = $(typeId).val();
        let $exp = $(targetId);
        $exp.empty();
        
        let list = (type === 'FUT') ? window.futExps : window.optExps;
        if(type === 'EQ') list = ['N/A'];
        
        if(list && list.length > 0) {
            list.forEach(d => $exp.append(`<option value="${d}">${d}</option>`));
        } else {
            $exp.append('<option>No Expiries</option>');
        }
        
        if(targetId === '#expiry_select') updateChain();
    }

    function updateChain() {
        let sym = $('#symbol_search').val();
        let exp = $('#expiry_select').val();
        let type = $('#inst_type').val();
        
        if (type === 'FUT' || type === 'EQ') {
            $('#strike_select').html('<option value="0">N/A</option>');
            fetchLTP();
            return;
        }

        $.get(`/api/chain?symbol=${sym}&expiry=${exp}&type=${type}&ltp=0`, (data) => {
            let $s = $('#strike_select'); 
            $s.empty();
            
            // Auto-select ATM
            let hasAtm = false;
            data.forEach(i => {
                let isAtm = i.label.includes("ATM");
                let style = isAtm ? "color:red; font-weight:bold;" : "";
                $s.append(`<option value="${i.strike}" style="${style}" ${isAtm?'selected':''}>${i.strike}</option>`);
                if(isAtm) hasAtm = true;
            });
            fetchLTP();
        });
    }

    function fetchLTP() {
        let sym = $('#symbol_search').val();
        let type = $('#inst_type').val();
        let exp = $('#expiry_select').val();
        let str = $('#strike_select').val();
        
        if(!sym) return;
        
        $.get(`/api/specific_ltp?symbol=${sym}&type=${type}&expiry=${exp}&strike=${str}`, (data) => {
            currentLTP = data.ltp;
            $('#inst-ltp').text("LTP: " + currentLTP);
            $('#limit_price').val(currentLTP);
            calcRisk();
        });
    }

    function calcRisk() {
        let sl_pts = parseFloat($('#sl_points').val()) || 0;
        if(currentLTP > 0) {
            $('#sl_price').val((currentLTP - sl_pts).toFixed(2));
            $('#t1_price').val((currentLTP + (sl_pts * 0.5)).toFixed(2));
            $('#t2_price').val((currentLTP + (sl_pts * 1.0)).toFixed(2));
        }
    }

    // --- HISTORY TAB LOGIC ---
    $('#hist_symbol').change(function() {
        let sym = $(this).val();
        if(!sym) return;
        $.get('/api/details?symbol=' + sym, (data) => {
            window.histFutExps = data.fut_expiries;
            window.histOptExps = data.opt_expiries;
            populateExpiries('#hist_type', '#hist_expiry');
        });
    });

    $('#hist_type').change(() => populateExpiries('#hist_type', '#hist_expiry'));

    window.checkHistory = function() {
        let data = {
            symbol: $('#hist_symbol').val(),
            type: $('#hist_type').val(),
            strike: $('#hist_strike').val(),
            expiry: $('#hist_expiry').val(),
            time: $('#hist_time').val()
        };
        
        $('#hist_result').show().html('<div class="spinner-border spinner-border-sm"></div> Checking...');
        
        $.get('/api/history_check', data, (res) => {
            if(res.status === 'success') {
                let d = res.data;
                $('#hist_result').html(`
                    <strong class="text-primary">${res.symbol}</strong><br>
                    <span class="text-muted small">${d.date}</span>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between"><span>Open:</span> <strong>${d.open}</strong></div>
                    <div class="d-flex justify-content-between"><span>High:</span> <strong>${d.high}</strong></div>
                    <div class="d-flex justify-content-between"><span>Low:</span> <strong>${d.low}</strong></div>
                    <div class="d-flex justify-content-between"><span>Close:</span> <strong>${d.close}</strong></div>
                `);
            } else {
                $('#hist_result').html(`<span class="text-danger fw-bold">Error:</span> ${res.message}`);
            }
        });
    };
</script>

</body>
</html>
