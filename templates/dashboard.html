<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Algo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { background: #eef2f6; font-family: sans-serif; padding-bottom: 80px; }
        .ticker { background: #000; color: #fff; padding: 5px; white-space: nowrap; overflow:hidden; font-size: 0.9rem; }
        .ticker span { margin-right: 15px; font-weight: bold; }
        .card { border-radius: 12px; border:none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .btn-check:checked + .btn-outline-primary { background: #0d6efd; color: #fff; }
        .form-control, .form-select { border-radius: 8px; font-size: 16px; background:#fff; }
        .risk-val { text-align: center; font-weight: bold; }
        .nav-pills .nav-link { border-radius: 20px; font-weight: 600; }
    </style>
</head>
<body>

<div class="ticker sticky-top">
    <span>NIFTY: <span id="n_lp" class="text-warning">0</span></span>
    <span>BANKNIFTY: <span id="b_lp" class="text-warning">0</span></span>
    <span>SENSEX: <span id="s_lp" class="text-warning">0</span></span>
</div>

<div class="container mt-3">
    {% with messages = get_flashed_messages() %}
        {% if messages %} <div class="alert alert-success">{{ messages[0] }}</div> {% endif %}
    {% endwith %}

    <ul class="nav nav-pills nav-fill mb-3 bg-white p-2 rounded">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#trade">üöÄ Trade</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#history">üìÖ History</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pos">üíº Pos</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="trade">
            <form action="/trade" method="post">
                <div class="card p-3">
                    <div class="d-flex justify-content-between mb-2">
                        <h5 class="fw-bold">New Order</h5>
                        <span id="inst_ltp" class="badge bg-primary">LTP: 0</span>
                    </div>

                    <div class="mb-3">
                        <input type="text" id="sym" name="index" class="form-control fw-bold" placeholder="Search Symbol..." list="sym_list" required>
                        <datalist id="sym_list"></datalist>
                    </div>

                    <div class="mb-3">
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="type" id="t1" value="CE" checked>
                            <label class="btn btn-outline-primary" for="t1">CE</label>
                            <input type="radio" class="btn-check" name="type" id="t2" value="PE">
                            <label class="btn btn-outline-primary" for="t2">PE</label>
                            <input type="radio" class="btn-check" name="type" id="t3" value="FUT">
                            <label class="btn btn-outline-primary" for="t3">FUT</label>
                            <input type="radio" class="btn-check" name="type" id="t4" value="EQ">
                            <label class="btn btn-outline-primary" for="t4">EQ</label>
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-6"><select name="expiry" id="exp" class="form-select"></select></div>
                        <div class="col-6"><select name="strike" id="str" class="form-select"></select></div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="small fw-bold text-muted">QTY (Lot:<span id="lot">1</span>)</label>
                            <input type="number" name="qty" id="qty" class="form-control fw-bold" value="1">
                        </div>
                        <div class="col-6">
                            <label class="small fw-bold text-muted">ORDER</label>
                            <select name="order_type" id="ord" class="form-select fw-bold">
                                <option value="LIMIT" selected>LIMIT</option>
                                <option value="MARKET">MARKET</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="lim_box" class="mb-3">
                        <label class="small fw-bold text-muted">LIMIT PRICE</label>
                        <input type="number" step="0.05" name="limit_price" id="lim_pr" class="form-control text-primary fw-bold">
                    </div>
                </div>

                <div class="card p-3">
                    <h6 class="fw-bold mb-3">üõ°Ô∏è Risk Manager</h6>
                    <div class="input-group mb-3">
                        <span class="input-group-text">SL Pts</span>
                        <input type="number" id="sl_pts" name="sl_points" class="form-control fw-bold text-center" value="20">
                    </div>
                    <div class="row g-2">
                        <div class="col-3"><small>SL</small><input type="number" step="0.05" id="p_sl" class="form-control risk-val text-danger" readonly></div>
                        <div class="col-3"><small>T1</small><input type="number" step="0.05" id="p_t1" name="t1_price" class="form-control risk-val text-success"></div>
                        <div class="col-3"><small>T2</small><input type="number" step="0.05" id="p_t2" name="t2_price" class="form-control risk-val text-success"></div>
                        <div class="col-3"><small>T3</small><input type="number" step="0.05" id="p_t3" name="t3_price" class="form-control risk-val text-success"></div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <div class="btn-group">
                        <input type="radio" class="btn-check" name="mode" id="m1" value="PAPER" checked>
                        <label class="btn btn-outline-warning" for="m1">PAPER</label>
                        <input type="radio" class="btn-check" name="mode" id="m2" value="LIVE">
                        <label class="btn btn-outline-danger" for="m2">LIVE</label>
                    </div>
                    <button type="submit" class="btn btn-dark btn-lg shadow">‚ö° EXECUTE</button>
                </div>
            </form>
        </div>

        <div class="tab-pane fade" id="history">
            <div class="card p-3">
                <h5 class="fw-bold">History Check</h5>
                <input type="text" id="h_sym" class="form-control mb-2" placeholder="Symbol" list="sym_list">
                <div class="row g-2 mb-2">
                    <div class="col-4">
                        <select id="h_type" class="form-select">
                            <option value="CE">CE</option><option value="PE">PE</option><option value="FUT">FUT</option>
                        </select>
                    </div>
                    <div class="col-8"><select id="h_exp" class="form-select"></select></div>
                </div>
                <input type="number" id="h_str" class="form-control mb-2" placeholder="Strike">
                <input type="datetime-local" id="h_time" class="form-control mb-3">
                <button onclick="checkHistory()" class="btn btn-info w-100 text-white fw-bold">Check</button>
                <div id="h_res" class="mt-3 p-3 bg-light border rounded" style="display:none"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="pos">
            <div class="card p-2">
                {% for t in trades %}
                <div class="border-bottom pb-2 mb-2">
                    <div class="d-flex justify-content-between">
                        <strong>{{ t.symbol }}</strong>
                        <span class="badge {{ 'bg-danger' if t.mode=='LIVE' else 'bg-warning text-dark' }}">{{ t.mode }}</span>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span>Avg: {{ t.entry_price }}</span>
                        <span>LTP: {{ t.current_ltp }}</span>
                    </div>
                    <div class="text-end mt-1">
                        <span class="badge bg-light text-dark border">{{ t.status }}</span>
                        {% if t.mode=='PAPER' %}<a href="/promote/{{ t.id }}" class="btn btn-sm btn-danger py-0">Go Live</a>{% endif %}
                    </div>
                </div>
                {% else %}
                <p class="text-center text-muted mt-3">No Active Trades</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    let curLTP = 0;
    
    // Ticker
    setInterval(() => {
        $.get('/api/indices', d => {
            $('#n_lp').text(d.NIFTY); $('#b_lp').text(d.BANKNIFTY); $('#s_lp').text(d.SENSEX);
        });
    }, 2000);

    // Search & Memory
    $('#sym').on('input', function() {
        let v = $(this).val();
        if(v.length < 2) return;
        $.get('/api/search?q='+v, d => {
            $('#sym_list').empty(); d.forEach(s => $('#sym_list').append(`<option value="${s}">`));
        });
    });

    $('#sym').change(function() {
        let s = $(this).val(); if(!s) return;
        let memSL = localStorage.getItem('sl_'+s);
        if(memSL) $('#sl_pts').val(memSL);

        $.get('/api/details?symbol='+s, d => {
            $('#lot').text(d.lot_size); $('#qty').val(d.lot_size);
            window.fut = d.fut_expiries; window.opt = d.opt_expiries;
            fillExp('#exp', 'input[name="type"]:checked');
        });
    });

    $('input[name="type"]').change(() => fillExp('#exp', 'input[name="type"]:checked'));
    $('#exp').change(fillChain);
    $('#str').change(fetchLTP);
    $('#sl_pts').on('input', function() {
        localStorage.setItem('sl_'+$('#sym').val(), $(this).val());
        calcRisk();
    });
    
    // Order Type Toggle
    $('#ord').change(function() { $('#lim_box').toggle($(this).val() === 'LIMIT'); });

    function fillExp(target, typeSrc) {
        let t = $(typeSrc).val(), $e = $(target).empty();
        let l = (t === 'FUT') ? window.fut : window.opt;
        if(t === 'EQ') l = ['N/A'];
        
        if(l) l.forEach((d,i) => $e.append(`<option value="${d}" ${i===0?'selected':''}>${d}</option>`));
        if(target === '#exp') fillChain();
    }

    function fillChain() {
        let s = $('#sym').val(), e = $('#exp').val(), t = $('input[name="type"]:checked').val();
        if(t === 'FUT' || t === 'EQ') { $('#str').html('<option value="0">N/A</option>'); fetchLTP(); return; }
        
        let spot = parseFloat($('#n_lp').text()) || 0; // Use Nifty as proxy for ATM calc
        $.get(`/api/chain?symbol=${s}&expiry=${e}&type=${t}&ltp=${spot}`, d => {
            let $k = $('#str').empty();
            d.forEach(r => {
                let st = r.label.includes('ATM') ? 'color:red;font-weight:bold' : '';
                $k.append(`<option value="${r.strike}" style="${st}" ${r.label.includes('ATM')?'selected':''}>${r.strike} ${r.label}</option>`);
            });
            fetchLTP();
        });
    }

    function fetchLTP() {
        let s = $('#sym').val(), e = $('#exp').val(), k = $('#str').val(), t = $('input[name="type"]:checked').val();
        if(!s) return;
        $.get(`/api/specific_ltp?symbol=${s}&expiry=${e}&strike=${k}&type=${t}`, d => {
            curLTP = d.ltp;
            $('#inst_ltp').text("LTP: "+curLTP);
            $('#lim_pr').val(curLTP);
            calcRisk();
        });
    }

    function calcRisk() {
        let pts = parseFloat($('#sl_pts').val()) || 0;
        if(curLTP > 0) {
            $('#p_sl').val((curLTP - pts).toFixed(2));
            $('#p_t1').val((curLTP + pts*0.5).toFixed(2));
            $('#p_t2').val((curLTP + pts*1.0).toFixed(2));
            $('#p_t3').val((curLTP + pts*2.0).toFixed(2));
        }
    }

    // History
    $('#h_sym').change(function() {
        $.get('/api/details?symbol='+$(this).val(), d => {
            window.hFut = d.fut_expiries; window.hOpt = d.opt_expiries;
            fillExp('#h_exp', '#h_type');
        });
    });
    $('#h_type').change(() => fillExp('#h_exp', '#h_type'));

    window.checkHistory = function() {
        let d = { symbol:$('#h_sym').val(), type:$('#h_type').val(), expiry:$('#h_exp').val(), strike:$('#h_str').val(), time:$('#h_time').val() };
        $('#h_res').show().text('Checking...');
        $.get('/api/history_check', d, r => {
            if(r.status==='success') $('#h_res').html(`<b>${r.symbol}</b><br>${r.data.date}<br>O:${r.data.open} H:${r.data.high} L:${r.data.low} C:${r.data.close}`);
            else $('#h_res').text(r.message);
        });
    };
</script>
</body>
</html>
